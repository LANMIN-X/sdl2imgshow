name: Build AArch64 Release (glibc 2.31)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Enable QEMU ARM64
        uses: docker/setup-qemu-action@v3

      - name: Build inside Ubuntu 20.04 ARM64 (glibc 2.31)
        run: |
          mkdir -p build_aarch64
          
          docker run --rm --platform=linux/arm64 \
            -v $PWD:/workspace \
            arm64v8/ubuntu:20.04 bash -e -c "

              echo '>>> Setting non-interactive mode for tzdata'
              export DEBIAN_FRONTEND=noninteractive
              ln -fs /usr/share/zoneinfo/UTC /etc/localtime

              echo '>>> Updating apt sources...'
              apt-get update

              echo '>>> Installing tzdata (non-interactive)...'
              apt-get install -y tzdata

              echo '>>> Installing build dependencies...'
              apt-get install -y cmake build-essential \
                libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev

              echo '>>> Running CMake build...'
              cd /workspace
              cmake -Bbuild_aarch64 -DCMAKE_BUILD_TYPE=Release
              cmake --build build_aarch64 -- -j4

              echo '>>> Checking linked GLIBC version'
              strings build_aarch64/sdl2imgshow | grep GLIBC_ || true
            "

      - name: Validate GLIBC version (must not exceed 2.33)
        run: |
          echo ">>> Verifying GLIBC version..."
          strings build_aarch64/sdl2imgshow | grep GLIBC_

          if strings build_aarch64/sdl2imgshow | grep -q 'GLIBC_2\.34\|GLIBC_2\.35\|GLIBC_2\.36\|GLIBC_2\.37\|GLIBC_2\.38\|GLIBC_2\.39'; then
            echo "❌ ERROR: Detected GLIBC version too new! Device supports up to GLIBC_2.33"
            strings build_aarch64/sdl2imgshow | grep GLIBC_
            exit 1
          fi

          echo "✅ GLIBC version OK (<= 2.33)"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdl2imgshow-aarch64
          path: build_aarch64/sdl2imgshow

      - name: Auto-generate tag
        id: tagger
        run: |
          echo "tag=aarch64-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagger.outputs.tag }}
          name: "AArch64 Build ${{ steps.tagger.outputs.tag }}"
          files: build_aarch64/sdl2imgshow
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Test ARM64 Images

on:
  workflow_dispatch:

jobs:
  test-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare test script
        run: |
          cat << 'EOF' > test.sh
          #!/bin/bash
          set -e
          echo "Testing ARM64 distros..."
          DISTROS=(
            alpine
            alpine_latest
            ubuntu20.04
            ubuntu22.04
            focal
            jammy
            fedora_latest
            fedora
            archlinux_latest
            centos7
            debian
            bullseye
            bookworm
          )

          for d in "${DISTROS[@]}"; do
            echo ""
            echo "=== Testing distro: $d ==="
            if \
              docker run --rm --platform=linux/arm64 "arm64v8/$d" uname -a 2>/dev/null; then
              echo "[$d] OK"
            else
              echo "[$d] FAIL"
            fi
          done
          EOF

          chmod +x test.sh

      - name: Run ARM64 test script
        run: ./test.sh
